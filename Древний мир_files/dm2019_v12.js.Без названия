var timeout_id = null;
var timeout_time = 25000;
var msgText = '';
var myid = '';
var mid = 0;
var pid = 0;
var cid = 0;
var kid = 0;
var testmsg = 0;
var isOpera;
var isOpera6;
var isOpera7;
var isDOM;
var isMSIE;
var isIE;
var isStrict;
var isNC;
var isNC4;
var isMozilla;
var isNN;
var isNN4;
var isNN6;
var sysmode=0;//1-опопвещ
// ---------
var Sound_SW = 0;
var CtrlPress = false;
var CounerCash = 0;
var MaxString = 5;
var UserLevel = 1;
// document.onmousedown=Down;
// function Down()
// {CtrlPress=window.event.ctrlKey;}

var startMsgA = 0;
var stopMsgA = 0;
var startCMsgA = 0;
var stopCMsgA = 0;
var startKMsgA = 0;
var stopKMsgA = 0;
var startAMsgA = 0;
var stopAMsgA = 0;

var maxMsgA = 200;// 200
var msgdiv = null;
var cmsgdiv = null;
var kmsgdiv = null;
var amsgsdiv = null;
var XFN = 0;
var MDIV = 0;
var tXFN = 0;
var mstore = Array();
var mstoreC = 0;
var blockSend = 0;
var lastMsgText = '';
var countDuplicateMsg = 0;
var isUserBan = false;
var startBanTime = null;
var privMode = 0;
var megaBeep='0';
var notSystem=0;
var ClanMode = 0;
var CommMode = 0;
var AljansMode = 0;

var time_click_msgdiv = null;
var time_click_cmsgdiv = null;
var time_click_kmsgdiv = null;
var time_click_amsgsdiv = null;
var CntMsg_0=0;
var CntMsg_1=0;
var CntMsg_2=0;
var CntMsg_3=0;
var CntMsg_4=0;

function StopXFN() {
	XFN = 0;
}
function StartXFN() {
	XFN = 1;
}

function SetCntrl() {
	if (window.event) {
		if (window.event.keyCode == 17) {
			CtrlPress = 1;
		} else {
			CtrlPress = 0;
		}
	}
}
function SetCntrlCancel() {
	CtrlPress = 0;
}
function init() {

 
	isDOM = document.getElementById ? true : false;
	isOpera = isOpera5 = window.opera && isDOM;
	isOpera6 = isOpera && window.print;
	isOpera7 = isOpera && document.readyState;
	isMSIE = isIE = document.all && document.all.item && !isOpera;
	isStrict = document.compatMode == 'CSS1Compat';
	isNN = isNC = navigator.appName == "Netscape";
	isNN4 = isNC4 = isNN && !isDOM;
	isMozilla = isNN6 = isNN && isDOM;
	if (parent.fr_main) {
		msgdiv = parent.fr_main.document.getElementById('msgs');
		cmsgdiv = parent.fr_main.document.getElementById('cmsgs');
		amsgsdiv = parent.fr_main.document.getElementById('amsgs');
		kmsgs = parent.fr_main.document.getElementById('kmsgs');
	}
	XFN = 1;
	MDIV = 1;
	reloadxfn();
}

function showCntMsg() {
	if (CntMsg_4>0 ){
		if (tXFN!=4){
            parent.fr_list.document.getElementById('chat_4').style.display = "block";
            parent.fr_list.document.getElementById('chat_4').setAttribute('data-badge', CntMsg_4);
		}
	}
    if (CntMsg_2>0){
        if (tXFN!=2) {
            parent.fr_list.document.getElementById('chat_2').style.display = "block";
            parent.fr_list.document.getElementById('chat_2').setAttribute('data-badge', CntMsg_2);
        }
    }
    if (CntMsg_1>0){
        if (tXFN!=1) {
            parent.fr_list.document.getElementById('chat_1').style.display = "block";
            parent.fr_list.document.getElementById('chat_1').setAttribute('data-badge', CntMsg_1);
        }
    }
    if (CntMsg_3>0){
        if (tXFN!=1) {
            parent.fr_list.document.getElementById('chat_3').style.display = "block";
            parent.fr_list.document.getElementById('chat_3').setAttribute('data-badge', CntMsg_3);
        }
    }
    // console.log(tXFN);
    // console.log(CntMsg_1, CntMsg_2, CntMsg_3, CntMsg_4);
}
// new
function conf_xfn_message_typeSet(mode) {
	 
	var vx=document.getElementById('img_filtr');
	if (vx!=null)
	{
		var srcimage = vx.src;
	if (mode == 'all') {
		privMode = 0;
				srcimage = srcimage.replace('prv_on.png','prv_off.png');
			vx.src = srcimage;
	}

	if (mode == 'prv') {
		privMode = 1;
		srcimage = srcimage.replace('prv_off.png','prv_on.png');
			vx.src = srcimage;
		}
	}
}

function conf_xfn_message_type2() {
	if (document.sndForm != null) {
		if (privMode == 1) {
			document.sndForm.v.value = '';
			document.sndForm.op.value = 'all';
		} else {
			document.sndForm.op.value = 'prv';
			document.sndForm.v.value = '';
		}
		document.sndForm.submit();
		document.sndForm.op.value ='';
	}
}

function snd_sw() {

	var srcimage = document.getElementById('img_snd').src;
	if (Sound_SW == 0) {
		Sound_SW = 1;
		srcimage = srcimage.replace('beep_off.png', 'beep_on.png');
		document.getElementById('img_snd').src = srcimage;
	} else {
		Sound_SW = 0;
		srcimage = srcimage.replace('beep_on.png', 'beep_off.png');
		document.getElementById('img_snd').src = srcimage;
	}
}

// ------ reloadxfn
function reloadxfn() {
    var fv='';
    var mv='';
	if (XFN == 1) {
		if (myid == '') {
			//document.gForm.f.value = 'gu';
			//document.gForm.v.value = 'm';
			//document.gForm.submit();
            var fv='gu';
            var mv='m';

            //timeout_id = setTimeout(reloadxfn, timeout_time);
		} else {
			var fv='g';
			//document.gForm.f.value = 'g';
			//document.gForm.submit();
            //timeout_id = setTimeout(reloadxfn, timeout_time);
		}

        var xhttp = new XMLHttpRequest();

        xhttp.open("GET", "../b/p.php?ax=1&f="+fv+"&v="+mv, true);
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                // document.getElementById("demo").innerHTML = this.responseText;
                 //alert(this.responseText);
                //console.log(this.responseText);

				try {

                    PCr(this.responseText);
                }catch(error) {
                    // console.log(error);

                }
            }
        };
        xhttp.send();

	}

		timeout_id = setTimeout(reloadxfn, timeout_time);

}
function YouTubeGetID(url){
    var ID = '';
    url = url.replace(/(>|<)/gi,'').split(/(vi\/|v=|\/v\/|youtu\.be\/|\/embed\/)/);
    if(url[2] !== undefined) {
        ID = url[2].split(/[^0-9a-z_\-]/i);
        return true
    }
    else {
      //  ID = url;
        return false;
    }
    //return ID;
}



function Linkify(inputText,newText) {
    //URLs starting with http://, https://, or ftp://
    var replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
    var replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank" style="text-decoration: none;"><span class="gnome">'+newText+'</span></a>');

    //URLs starting with www. (without // before it, or it'd re-link the ones done above)
    var replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
    var replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank"  class="url"   style="text-decoration: none;"><span class="gnome">'+newText+'</span></a>');

    //Change email addresses to mailto:: links
    //var replacePattern3 = /(\w+@[a-zA-Z_]+?\.[a-zA-Z]{2,6})/gim;
    //var replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1">$1</a>');

    return replacedText
}
function urlify(text) {
   // var siteText='ссылка';
    var sourceString ='';
    var newText='ссылка';
    var sourceString = text.replace('http://','').replace('https://','').replace('www.','').split(/[/?#]/)[0];


    if (YouTubeGetID(text) ){
        newText='видео youtube';
    }else{
        if (sourceString=='dm-game.com' || sourceString=='test.elder.kiev.ua'){
            newText='читай в ДМ';
            var n = text.search("forum");
            if (n>0){
                newText='читай в ДМ форум';
			}
            var n = text.search("log");
            if (n>0){
                newText= 'Дм лог боя';
            }
            var n = text.search("infouser");
            if (n>0){
                newText= 'Дм см. героя';
            }

        }else{

        }
	}

 	return Linkify(text,newText);

}
// t0-min, t1-sec, n-type(System/...), i-uid, c-color(Black/...), m-text
function m(t0, t1, n, i, t, c, ms, stl, spl, rname, idtext) {
	// alert('t0:'+t0+'; '+'t1:'+t1+'; '+'n:'+n+'; '+'i:'+i+'; '+'t:'+t+' '+'c:'+c+'; '+'m:'+m+'; '+'stl:'+stl+'; '+'spl:'+spl+'; ');
	// console.log(t0, t1, n, i, t, c, ms, stl, spl, rname, idtext);
//	 alert(ms);
	if (typeof(ignor_list) != null && ignor_list[i] != null) {
		return '';
	}
	var isPrw = 0;
	if (!ms) {
		return '';
	}
	if (i==3){
		n='Система';
		spl={};
		
	}
    if (i==4){
        n='Система';
    }
	if (!c){
		c='Black';
	}
	ms=ms.replace(/_znakk__lapka_/g,'&quot;');
	ms=ms.replace(/_znakk_`/g,'&lsquo;');
	var senderTxt='';
	if (i) {
		tl = eval(stl);
		pl = eval(spl);
		// console.log(stl);
		// console.log(spl);
		// console.log("=========");
		// console.log(tl);
		// console.log(pl);
		// console.log(eval(rname));
		if (rname) {
			mopen = rname;
		} else {
			mopen = n;
		}
		sender = '<a style="text-decoration:none; cursor:pointer;"  onClick="parent.fr_send.toMsg(\''
			+ mopen
			+ '\');" oncontextmenu="return OpenMenu(\''
			+ mopen
			+ '\',\''
			+ idtext
			+ '\',event);"><span class="'
			+ t
			+ '"> ['
			+ n + ']</span></a>: ';
		tclass = '';
		to = '';
		if (tl) {
			for (j = 0; j < tl.length; j++) {
                if (tl[j]['i']==3){
                    tl[j]['t']='people';
                    tl[j]['n']='Система';
                }
				if (tl[j]['i'] == myid) // for my
				{// sBeep();
					tclass = 'to';
					sndTos = n;
				} else {
					sndTos = tl[j]['n'];
					
				}
				to = to
				+ ' <strong>to</strong><a style="text-decoration:none;cursor:pointer;" onClick="parent.fr_send.toMsg(\''
				+ sndTos + '\');" oncontextmenu="return OpenMenu(\''
				+ tl[j]['n'] + '\',\'' + idtext
				+ '\',event);"><span class="' + tl[j]['t'] + '"> ['
				+ tl[j]['n'] + ']</span></a> ';
			}
		}
		prv = '';
		if (pl) {
			for (j = 0; j < pl.length; j++) {

				if (i == myid) {
					tclass = '';
					Prv = pl[j]['n'];
				} else {
					isPrw = 1;
					tclass = 'privat';
					if (pl[j]['i'] == myid) {
						Prv = n;
					} else {
						Prv = pl[j]['n'];
					}
				}


				senderTxt+=pl[j]['n'] +' ';
				prv = prv
				+ ' <span class="warning">privat</span><a style="text-decoration:none; cursor:pointer;" onClick="parent.fr_send.prvMsg(\''
				+ Prv + '\');" oncontextmenu="return OpenMenu(\''
				+ pl[j]['n'] + '\',\'' + idtext
				+ '\',event);"><span class="' + pl[j]['t'] + '"> ['
				+ pl[j]['n'] + ']</span></a> ';
			}
		}
		if (t0.length < 2)
		{
			t0 = '0' + t0;
		}
		if (t1.length < 2)
		{
			t1 = '0' + t1;
		}
		date = '<span class="' + tclass + '">' + t0 + ':' + t1 + '</span>';
		
		var chkMp3=ms.split('.');					
		var ext = chkMp3[chkMp3.length-1];
		if (ext=='mp3')
		{			
			ms='[play]'+ms+'[/play]';	
		}	
		var PlayRe = /\[play\](.*)\[\/play\]/ig;
		var PlayArr = PlayRe.exec(ms);
			
		if (PlayArr != null && PlayArr[1]!=undefined) {			
					var mp3File=PlayArr[1].trim();
					var chkMp3=mp3File.split('.');					
					var ext = chkMp3[chkMp3.length-1];
					 
					if (ext=='mp3'){
						PlayArr[1]=PlayArr[1].replace("'", "");	
						var idmp3='_'+Math.random().toString(36).substr(2, 9);
						var _mp3='<a style="text-decoration:none; cursor:pointer;" onClick="parent.frames[\'menu\'].playMp3(\''+PlayArr[1]+'\',\''+idmp3+'\')"><img src="/layout/all/smiles/play.png" id="'+idmp3+'"/><img src="/layout/all/smiles/ar.gif" title="Проиграть музыку"></a>';
						ms=ms.replace("[play]"+PlayArr[1]+"[/play]", _mp3);	
					}else{
						ms=ms.replace("[play]"+PlayArr[1]+"[/play]", '*** слушаю музыку ****');	
						ms=ms.replace('[play]', '');	
						ms=ms.replace('[/play]', '');	
					}
					
			}else{
            ms=urlify(ms);

		}
		
		var social = false;
		var social_id = null;
		//for ( var j = 0; j < emoid.length; j++) {
		//	var re = new RegExp("^\\"+emoid[j]+"", "i");
		//	if (re.test(ms)) {
		//		social = true;
		//		social_id = j;
		//	}
		//}
		if (social) {
			var re = new RegExp("^\\"+emoid[social_id], "i");
			var social_nick = ms.replace(re, '');
			social_nick = social_nick.replace(/^\s+|\s+$/g, '');//Обрезать пробелы
			social_nick=social_nick.replace(/[^a-zA-Zа-яА-ЯіІїЇєЄ0-9\(\)_\s]+/g, "");//Удаляем ненужные символы
			var social_text = '';
			var rnd_num = random_number(0, emotext[social_id].length-1);
			var social_msg = (i==myid?emotext[social_id][rnd_num]['for_me']:emotext[social_id][rnd_num]['for_other']);
			if (social_nick=='') {//Никому
				social_text = social_msg['empty'];
			} else if (n==social_nick) {//Себе
				social_text = social_msg['self'];
			} else {//Другому
				social_text = social_msg['other'];
			}
			social_text = replaceAll(social_text, '%from%', '<a style="text-decoration:none; cursor:pointer;" onClick="parent.fr_send.toMsg(\''+ mopen+ '\');" oncontextmenu="return OpenMenu(\''+ mopen+ '\',\'' + idtext+ '\',event);"><span class="'+ t+ '"> ' + n + '</span></a>');
			social_text = replaceAll(social_text, '%to%', '<a style="text-decoration:none; cursor:pointer;" onClick="parent.fr_send.toMsg(\''+ social_nick+ '\');" oncontextmenu="return OpenMenu(\''+ social_nick+ '\',\'' + idtext+ '\',event);"><span class="'+ t+ '"> ' + social_nick + '</span></a>');
			StrDiv = '<div>'+date + ' <span class="social">' + social_text + '</span></div>';
		} else if (i == 3) {
			var nickRe = /\[nick\]([^\[\]]*)\|([^\[\]]*)\[\/nick\]/ig;//nick; [1]-nick, [2]-race
			var nickArr = null;
			while(nickArr = nickRe.exec(ms))
			{
				if (nickArr != null && nickArr[1]!=undefined) {
					var _nick = '<a style="text-decoration:none; cursor:pointer;" onClick="parent.fr_send.prvMsg(\''
						+ nickArr[1] + '\');" oncontextmenu="return OpenMenu(\''
						+ nickArr[1] + '\',\''+idtext+'\',event);"><span class="' + nickArr[2] + '"> '
						+ nickArr[1] + '</span></a> ';
					ms=ms.replace("[nick]"+nickArr[1]+"|"+nickArr[2]+"[/nick]", _nick);
				} else
				{
					break;
				}
			}
			// Link
			var linkRe = /\[link\]([^\[\]]*)\|([^\[\]]*)\[\/link\]/ig;//link; [1]-href, [2]-name
			var linkArr = null;
			while(linkArr = linkRe.exec(ms))
			{
				if (linkArr != null && linkArr[1]!=undefined) {
					var _link = '<a href="'+linkArr[1]+'" target="_blank" style="text-decoration: none;"><span class="gnome">'+linkArr[2]+'</span></a>';
					ms=ms.replace("[link]"+linkArr[1]+"|"+linkArr[2]+"[/link]", _link);
				} else
				{
					break;
				}
			}

            var levelRe = /\[level\](.*)\[\/level\]/ig;
			var levelArr = levelRe.exec(ms);
			var UserAcceptLevel = false;
			if (levelArr != null && levelArr[1]!=undefined) {
				ms=ms.replace(levelRe, "");
				levelArr = levelArr[1].split("|");
				for ( var j = 0; j < levelArr.length; j++) {
					if (levelArr[j]==UserLevel) {
						UserAcceptLevel=true;
						break;
					}
				}
			}
			if (levelArr != null && UserAcceptLevel || levelArr == null)
			{
				StrDiv = '<span class="warning">' + date + ' ' + '</span>' + sender
				+ prv + to + '<font color=red>' + ms + '</font><br>';
			} else
			{
				return '';
			}
		} else
			// alert(date);
			StrDiv = date + ' ' + sender + prv + to + '<span class="' + c+ '">' + ms + '</span>' + '<br>';
	}
	//alert('isPrw='+isPrw+' '+'kid='+kid + ' cid='+cid);
	 
	if (isPrw == 1) {
		
		if (sysmode==1) 
		{
			SendNotife('Сообщение: '+senderTxt,ms);
		}
		
		sBeep();
		writeMsg(StrDiv, 0); // общий

		if (CommMode == 1) {
			writeMsg(StrDiv, 1); // Ком
		}

		if (ClanMode == 1) {
			writeMsg(StrDiv, 2); // Клан
		}

		if (AljansMode == 1) {
			writeMsg(StrDiv, 4); // Альянс
		}
		// console.log(CommMode);
		StrDiv = '';
		// if (cid!=0) writeMsg(StrDiv,1);if (kid!=0) writeMsg(StrDiv,2);
	}


	if (i == myid)
	{
		
		sBeepM();
	}

	return StrDiv;
}

function random_number(min, max) {
    return (Math.round((max-min) * Math.random() + min));
}

function sBeep() {
	if (Sound_SW == 1) {
		 BeepOk(2);
		//beep.gotoAndStop('/SoundPlayer', 'start');
		//window.setTimeout('stBeep()', 300);
	}
}
function stBeep() {
	 BeepOk(1);
//	beep.gotoAndStop('/SoundPlayer', 'stop');
}
function sBeepM() {
	if (Sound_SW == 1) {
		 BeepOk(3);
		//beepm.gotoAndStop('/SoundPlayer', 'start');
		//window.setTimeout('stBeepM()', 300);
	}
}
function stBeepM() {
	//beepm.gotoAndStop('/SoundPlayer', 'stop');
}

// -------

function replaceAll(oldStr, findStr, repStr) {
	var srchNdx = 0; // srchNdx will keep track of where in the whole line
	// of oldStr are we searching.
	var newStr = ""; // newStr will hold the altered version of oldStr.
	while (oldStr.indexOf(findStr, srchNdx) != -1)
	// As long as there are strings to replace, this loop
	// will run.
	{
		newStr += oldStr.substring(srchNdx, oldStr.indexOf(findStr, srchNdx));
		// Put it all the unaltered text from one findStr to
		// the next findStr into newStr.
		newStr += repStr;
		// Instead of putting the old string, put in the
		// new string instead.
		srchNdx = (oldStr.indexOf(findStr, srchNdx) + findStr.length);
		// Now jump to the next chunk of text till the next findStr.
	}
	newStr += oldStr.substring(srchNdx, oldStr.length);
	// Put whatever's left into newStr.
	return newStr;
}

// -------

function Pars_to_msg(username, str, msg) {
	var txt_parser = msg;
	var ntxt = str + ' [' + username + '] ';

	var i = txt_parser.indexOf(ntxt);
	{
		var ntxt2 = '';
		i = txt_parser.indexOf(ntxt2);
		if (i != -1) {
			txt_parser = txt_parser.substr(0, i) + str + ' [' + username + '] '
					+ txt_parser.substr(i + ntxt2.length, txt_parser.length);
		} else {
			txt_parser = ntxt + txt_parser;
		}
	}
	return txt_parser;
}

function toMsg(username) {
	if (CtrlPress) {
		window.open('/index.php?file=infouser&login=' + username);
	} else {
		Textxfn = document.getElementById('msgput');
		Textxfn.focus();
		Textxfn.value = Pars_to_msg(username, 'to', Textxfn.value);
	}
}
function prvMsg(username) {
	Textxfn = document.getElementById('msgput');
	if (Textxfn != null) {
		Textxfn.focus();
		Textxfn.value = Pars_to_msg(username, 'privat', Textxfn.value);
	}
}

function prvMsgClause(idtext) {
	Textxfn = document.getElementById('msgput');
	if (Textxfn != null) {
		Textxfn.focus();
		Textxfn.value = Pars_to_msg('Система', 'privat', Textxfn.value)
				+ 'Заявление #' + idtext + ' ';
	}
}
function prvNMsg() {
	document.getElementById('msgput').value = document.getElementById('msgput').value
			+ ' privat ' + '[' + ']' + ' ';
	document.getElementById('msgput').focus();
}
function prvMMsg(username) {
	document.getElementById('msgput').value = document.getElementById('msgput').value
			+ ' to ' + '[' + username + ']' + ' ';
	document.getElementById('msgput').focus();
}

function clearMsg() {
	document.getElementById('msgput').value = ''
}
// --------- IMG
function MM_preloadImages() { // v3.0
	var d = document;
	if (d.images) {
		if (!d.MM_p)
			d.MM_p = new Array();
		var i, j = d.MM_p.length, a = MM_preloadImages.arguments;
		for (i = 0; i < a.length; i++)
			if (a[i].indexOf("#") != 0) {
				d.MM_p[j] = new Image;
				d.MM_p[j++].src = a[i];
			}
	}
}

function MM_findObj(n, d) { // v4.01
	var p, i, x;
	if (!d)
		d = document;
	if ((p = n.indexOf("?")) > 0 && parent.frames.length) {
		d = parent.frames[n.substring(p + 1)].document;
		n = n.substring(0, p);
	}
	if (!(x = d[n]) && d.all)
		x = d.all[n];
	for (i = 0; !x && i < d.forms.length; i++)
		x = d.forms[i][n];
	for (i = 0; !x && d.layers && i < d.layers.length; i++)
		x = MM_findObj(n, d.layers[i].document);
	if (!x && d.getElementById)
		x = d.getElementById(n);
	return x;
}

function MM_nbGroup(event, grpName) { // v6.0
	var i, img, nbArr, args = MM_nbGroup.arguments;
	if (event == "init" && args.length > 2) {
		if ((img = MM_findObj(args[2])) != null && !img.MM_init) {
			img.MM_init = true;
			img.MM_up = args[3];
			img.MM_dn = img.src;
			if ((nbArr = document[grpName]) == null)
				nbArr = document[grpName] = new Array();
			nbArr[nbArr.length] = img;
			for (i = 4; i < args.length - 1; i += 2)
				if ((img = MM_findObj(args[i])) != null) {
					if (!img.MM_up)
						img.MM_up = img.src;
					img.src = img.MM_dn = args[i + 1];
					nbArr[nbArr.length] = img;
				}
		}
	} else if (event == "over") {
		document.MM_nbOver = nbArr = new Array();
		for (i = 1; i < args.length - 1; i += 3)
			if ((img = MM_findObj(args[i])) != null) {
				if (!img.MM_up)
					img.MM_up = img.src;
				img.src = (img.MM_dn && args[i + 2]) ? args[i + 2]
						: ((args[i + 1]) ? args[i + 1] : img.MM_up);
				nbArr[nbArr.length] = img;
			}
	} else if (event == "out") {
		for (i = 0; i < document.MM_nbOver.length; i++) {
			img = document.MM_nbOver[i];
			img.src = (img.MM_dn) ? img.MM_dn : img.MM_up;
		}
	} else if (event == "down") {
		nbArr = document[grpName];
		if (nbArr)
			for (i = 0; i < nbArr.length; i++) {
				img = nbArr[i];
				img.src = img.MM_up;
				img.MM_dn = 0;
			}
		document[grpName] = nbArr = new Array();
		for (i = 2; i < args.length - 1; i += 2)
			if ((img = MM_findObj(args[i])) != null) {
				if (!img.MM_up)
					img.MM_up = img.src;
				img.src = img.MM_dn = (args[i + 1]) ? args[i + 1] : img.MM_up;
				nbArr[nbArr.length] = img;
			}
	}
}
function writeMsg(msg, wXFN) {
	msg = unescape(msg);
	if (MDIV == 0) {
		setTimeout('writeMsg("' + escape(msg) + '",' + wXFN + ')', 500);
	} else {
		MDIV = 0;
		writeMsg0(msg, wXFN);
		MDIV = 1;
	}
}
function writeMsg0(msg, wXFN) {
	//alert('writeMsg0='+msg+' wXFN=' +wXFN);

	if (wXFN == 0) 
	{
		if (msgdiv == null)
		{
			msgdiv = parent.fr_main.document.getElementById('msgs');
		}
	 
		if (msgdiv != null) {
			smsg = putsmile(msg);
			msgDiv = '<div id="x_m_d_id_' + stopMsgA + '">' + smsg + '</div>';
			stopMsgA++;
	 
			var countMsgA = stopMsgA - startMsgA;

			if (countMsgA > maxMsgA) 
			{
				for (i = startMsgA; i < (stopMsgA - maxMsgA); i++) 
				{
					delmsgndiv = parent.fr_main.document.getElementById('x_m_d_id_' + i);
					if (delmsgndiv) 
					{
						msgdiv.removeChild(delmsgndiv);
					}
				}
				startMsgA = i;
			}
			
			if (countMsgA > 10000) 
			{
				startMsgA = 0;
				stopMsgA = 0;
			}
			
			msgdiv.innerHTML += msgDiv;
			var pin_fixed = parent.fr_main.document.querySelector('#msgs').dataset.pin_fixed;
			if (tXFN == 0 && pin_fixed == 1)
			{
				var bar = parent.fr_main.document.querySelector('.simplebar-content-wrapper');
				if (bar != null) {
					bar.scrollTop = bar.scrollHeight;
				}else {
                    
					// statements to handle any unspecified exceptions
					parent.fr_main.scroll(0, getHeight(amsgsdiv)- getWindowHeight(parent.fr_main.window) + 20);
				}

			}
		}

	} else if (wXFN == 1) {
		var delmsgndiv = null;
		if (cmsgdiv == null){
            cmsgdiv = parent.fr_main.document.getElementById('cmsgs');
		}

		if (cmsgdiv != null) {

			 
			smsg = putsmile(msg);
			msgDiv = '<div id="x_m_d_id_c_' + stopCMsgA + '">' + smsg+ '</div>';
			stopCMsgA++;
			var countCMsgA = stopCMsgA - startCMsgA;
			if (countCMsgA > maxMsgA) {
				for (i = startCMsgA; i < (stopCMsgA - maxMsgA); i++) {
					delmsgndiv = parent.fr_main.document
							.getElementById('x_m_d_id_c_' + i);
					if (delmsgndiv) {
						cmsgdiv.removeChild(delmsgndiv);
					}
				}
				startCMsgA = i;
			}

			cmsgdiv.innerHTML += msgDiv;
			var pin_fixed = parent.fr_main.document.querySelector('#msgs').dataset.pin_fixed;
			if (tXFN == 1 && pin_fixed == 1){
				var bar = parent.fr_main.document.querySelector('.simplebar-content-wrapper');
				if (bar != null) {
					bar.scrollTop = bar.scrollHeight;
				}else {
					// statements to handle any unspecified exceptions
                    
					parent.fr_main.scroll(0, getHeight(amsgsdiv)- getWindowHeight(parent.fr_main.window) + 20);
				}
			}

		}
		 
	} else if (wXFN == 2) {
		var delmsgndiv = null;
		if (kmsgdiv == null) {
            kmsgdiv = parent.fr_main.document.getElementById('kmsgs');
        }
		if (kmsgdiv != null) {
			smsg = putsmile(msg);
			msgDiv = '<div id="x_m_d_id_k_' + stopKMsgA + '">' + smsg
					+ '</div>';
			stopKMsgA++;
			var countKMsgA = stopKMsgA - startKMsgA;
			if (countKMsgA > maxMsgA) {
				for (i = startKMsgA; i < (stopKMsgA - maxMsgA); i++) {
					delmsgndiv = parent.fr_main.document
							.getElementById('x_m_d_id_k_' + i);
					if (delmsgndiv) {
						kmsgdiv.removeChild(delmsgndiv);
					}
				}
				startKMsgA = i;
			}

			kmsgdiv.innerHTML += msgDiv;
			var pin_fixed = parent.fr_main.document.querySelector('#msgs').dataset.pin_fixed;
			if (tXFN == 2 && pin_fixed == 1) {
				var bar = parent.fr_main.document.querySelector('.simplebar-content-wrapper');
				if (bar != null) {
					bar.scrollTop = bar.scrollHeight;
				}else {
					// statements to handle any unspecified exceptions
                    
					parent.fr_main.scroll(0, getHeight(amsgsdiv)- getWindowHeight(parent.fr_main.window) + 20);
				}

            }
		}
	//	time_click_kmsgdiv =0;
	}else if (wXFN == 4) {
		var delmsgndiv = null;
		if (amsgsdiv == null)
			amsgsdiv = parent.fr_main.document.getElementById('amsgs');
		if (amsgsdiv != null) {
			smsg = putsmile(msg);
			msgDiv = '<div id="x_m_d_id_a_' + stopAMsgA + '">' + smsg+ '</div>';
			stopAMsgA++;
			var countAMsgA = stopAMsgA - startAMsgA;
			if (countAMsgA > maxMsgA) {
				for (i = startAMsgA; i < (stopAMsgA - maxMsgA); i++) {
					delmsgndiv = parent.fr_main.document.getElementById('x_m_d_id_a_' + i);
					if (delmsgndiv) {
						amsgsdiv.removeChild(delmsgndiv);
					}
				}
				startAMsgA = i;
			}

			amsgsdiv.innerHTML += msgDiv;
			var pin_fixed = parent.fr_main.document.querySelector('#msgs').dataset.pin_fixed;
			if (tXFN == 4 && pin_fixed == 1){
				var bar = parent.fr_main.document.querySelector('.simplebar-content-wrapper');
				if (bar != null) {
					bar.scrollTop = bar.scrollHeight;
				}else {
					// statements to handle any unspecified exceptions
                    
					parent.fr_main.scroll(0, getHeight(amsgsdiv)- getWindowHeight(parent.fr_main.window) + 20);
				}

			}

		}
	 
	}

    showCntMsg();
}

// ---
function rfrFr() {
}

// ---
function censured(Msg) {
	var M0 = '';
	var M1 = '';
	re2 = new RegExp("(cens(u|o)red)", "gi");
	M1 = Msg.replace(re2, '*censored*');
	return M1;
}
// ---
function filtrSmiles(SmileList) {
	LimitSmiles = 4;
	TotalSmiles = 0;
	var World = SmileList.split('::');
	if (World.length >= LimitSmiles) {
		List = '';
		for (i = LimitSmiles; i < World.length; i++) {
			WorldSmile = World[i].split(' ');
			if (WorldSmile.length >= 1) {
				for (j = 1; j < WorldSmile.length; j++) {
					List = List + ' ' + WorldSmile[j];
				}
			}
		}
		GetRestSmile = World[0];
		for (z = 1; z < LimitSmiles; z++) {
			GetRestSmile = GetRestSmile + '::' + World[z];
		}
		return GetRestSmile + List;
	} else {
		strRes = SmileList;
		return strRes;
	}
}
// ---
function sendMsg() {
	msgText = msgText + document.getElementById('msgput').value;
	if (msgText != '') {
		if (isUserBan == true) {
			now = new Date();
			if (now.getTime() - startBanTime.getTime() > 30000) {// проверка
																	// на время
																	// блокировки
																	// - 30 сек.
				isUserBan = false;
				lastMsgText = '';
				countDuplicateMsg = 0;
			} else {
				msgText = '';
				document.getElementById('msgput').value = '';
				writeMsg0('Чат заблокировано на 30 секунд.', 0);
				if (ClanMode == 1) {
					writeMsg0('Чат заблокировано на 30 секунд.', 2);
				}
				return false;
			}
		} else if (msgText == lastMsgText) {
			countDuplicateMsg += 1;
			if (countDuplicateMsg >= 3) {
				// TODO spam-ban
				isUserBan = true;
				startBanTime = new Date();
				msgText = '';
				document.getElementById('msgput').value = '';
				writeMsg0('Чат заблокировано на 30 секунд.', 0);
				return false;
			}
		} else {
			countDuplicateMsg = 0;
			lastMsgText = msgText;
		}

		msgText = censured(msgText);
		msgText = filtrSmiles(msgText);
		msgText = replaceAll(msgText, '\\', '_znakk_');
		msgText = replaceAll(msgText, '#', '_znakresh_');
		msgText = replaceAll(msgText, '%', '_znakprocent_');
		msgText = replaceAll(msgText, '+', '_znakplus_');
		msgText = replaceAll(msgText, '&', '_znakam_');
		msgText = replaceAll(msgText, ';', '_znaktzpt_');
		msgText = replaceAll(msgText, '>', '_znakbls_');
		msgText = replaceAll(msgText, '<', '_znakmens_');

		if (tXFN == 0) {
			document.sndForm.f.value = "s";
		} else if (tXFN == 1) {
			document.sndForm.f.value = "sc";
		} else if (tXFN == 2) {
			document.sndForm.f.value = "sk";
		}
		// console.log(tXFN); //COMAND CHAT
		document.sndForm.v.value = msgText;
		document.sndForm.submit();
		// console.log(document.sndForm.submit());
		msgText = '';
	}
	document.getElementById('msgput').value = '';
}

// ------
function opensmiles(url, w, h, sb, wname) {
	if (isMSIE) {
		opensmiles_ie(url, w, h, sb, wname)
	} else {
		opensmiles_noie(url, w, h, sb, wname)
	}
}
function opensmiles_noie(url, w, h, sb, wname) {
	atr = '';
	atr = atr + 'toolbar=no,';
	if (sb) {
		atr = atr + 'scrollbars=no,';
	} else {
		atr = atr + 'scrollbars=yes,';
	}
	atr = atr + 'location=no,';
	atr = atr + 'statusbar=no,';
	atr = atr + 'menubar=no,';
	atr = atr + 'resizable=no,';
	if (w) {
		atr = atr + 'width=' + w + ',';
		atr = atr + 'height=' + h;
	} else {
		atr = atr + 'width=700,';
		atr = atr + 'height=500';
	}
	if (!wname) {
		wname = '_blank'
	}
	new_window = window.open(url, wname, atr);
	new_window.focus();
}
function opensmiles_ie(url, w, h, sb, wname) {
	var x = event.screenX - 180;
	var y = event.screenY - 390;
	var sFeatures = 'dialogLeft:'
			+ x
			+ 'px;dialogTop:'
			+ y
			+ 'px;dialogHeight:400px;dialogWidth:365px;help:no;status:no;unadorned:yes';
	window.showModelessDialog(url, window, sFeatures);
}

//Установка личных сообщений
function setSysNotife(){
		if (document.sndForm != null) {
		if (sysmode == 0) {
			sysmode=1;
			document.sndForm.v.value = '';
			document.sndForm.op.value = 'sys_on';
		} else {
			sysmode=0;
			document.sndForm.op.value = 'sys_off';
			document.sndForm.v.value = '';
		}
		document.sndForm.submit();
		document.sndForm.op.value = '';
	}
}
function sysNotifeIcon() 
{ 
 
	var vx=document.getElementById('img_sysNotife');
	if (vx!=null)
	{
		 
		var srcimage = vx.src;
		if (sysmode==1) {
			privMode = 0;
			srcimage = srcimage.replace('sys_off.png','sys_on.png');
			vx.src = srcimage;
		}else{
				
				srcimage = srcimage.replace('sys_on.png','sys_off.png');
				vx.src = srcimage;	
		}	
	}
}
// ------------ Clear xfn
function conf_xfn_clear() {
	var truthBeTold = window.confirm("Очистить окно чата  ?");

	if (truthBeTold) {
		if (tXFN == 0) {
			if (parent.fr_main.document.getElementById('msgs') != null) {
				parent.fr_main.document.getElementById('msgs').innerHTML = '';
				startMsgA = 0;
				stopMsgA = 0;
				CntMsg_0=0;
				CntMsg_1=0;
                showCntMsg();
				clearMsg();
			}
		} else if (tXFN == 1) {
			if (parent.fr_main.document.getElementById('cmsgs') != null) {
				parent.fr_main.document.getElementById('cmsgs').innerHTML = '';
				startCMsgA = 0;
				stopCMsgA = 0;
                CntMsg_1=0;
                showCntMsg();
				clearMsg();
			}
		} else if (tXFN == 2) {
			if (parent.fr_main.document.getElementById('kmsgs') != null) {
				parent.fr_main.document.getElementById('kmsgs').innerHTML = '';
				startKMsgA = 0;
				stopKMsgA = 0;
                CntMsg_2=0;
                showCntMsg();
				clearMsg();
			}
		} else if (tXFN == 4) {
			if (parent.fr_main.document.getElementById('amsgs') != null) {
				parent.fr_main.document.getElementById('amsgs').innerHTML = '';
				startAMsgA = 0;
				stopAMsgA = 0;
                CntMsg_4=0;
                showCntMsg();
				clearMsg();
			}
		}
	}
}

//------------ Translit xfn
function conf_xfn_translit() {
	var str = document.getElementById('msgput').value;
	var re = /(.*[to|privat]\s\[[^\]]*\]\s*)(.*)$/;
	var result = re.exec(str);
	if (result!=null) {
		result = result[1]+translitMsg(result[2]);
	} else {
		result = translitMsg(str);
	}
	document.getElementById('msgput').value = result;
}

function translitMsg(str) {
	var i = 0;
	var sm_re = /::\w+/g;
	var sm_1 = new Array();
	var sm_2 = new Array();
	while ((smiles = sm_re.exec(str)) != null) {
		sm_1.push(smiles[0]);
		sm_2.push("::" + (++i));
	}
	for (i = 0; i < sm_1.length; i++) {
		re = RegExp(sm_1[i], "g");
		str = str.replace(re, sm_2[i]);
	}
	Lat = new Array("''", "w", "jo", "yu", "je", "ya", "zh", "'", "ch",
			"c", "u", "k", "e", "n", "g", "sh", "z", "x", "q", "f", "y",
			"v", "a", "p", "r", "o", "l", "d", "s", "m", "i", "t", "b",
			"j", "h", "SH", "ZH", "CH", "H", "W", "JO", "YU", "JE", "YA",
			"C", "U", "K", "E", "N", "G", "Z", "X", "Q", "F", "Y", "V",
			"A", "P", "R", "O", "L", "D", "J", "S", "M", "I", "T", "B","Y");
	Rus = new Array("Ь", "щ", "ё", "ю", "э", "я", "ж", "ь", "ч", "ц", "у",
			"к", "е", "н", "г", "ш", "з", "х", "ъ", "ф", "ы", "в", "а",
			"п", "р", "о", "л", "д", "с", "м", "и", "т", "б", "й", "х",
			"Ш", "Ж", "Ч", "Х", "Щ", "Ё", "Ю", "Э", "Я", "Ц", "У", "К",
			"Е", "Н", "Г", "З", "Х", "Ъ", "Ф", "Ы", "В", "А", "П", "Р",
			"О", "Л", "Д", "Й", "С", "М", "И", "Т", "Б", "Й")
	for (i = 0; i < Lat.length; i++) {
		re = RegExp(Lat[i], "g");
		str = str.replace(re, Rus[i]);
	}
	for (i = 0; i < sm_1.length; i++) {
		re = RegExp(sm_2[i], "g");
		str = str.replace(re, sm_1[i]);
	}
	return str;
}

function AddSmilesText(code) {
	if (parent.fr_send.document.getElementById('msgput') != null) {
		parent.fr_send.document.getElementById('msgput').value = parent.fr_send.document
				.getElementById('msgput').value
				+ ' ' + code + ' ';
	}
}

function putsmile(msgstr) {

	// schar[60]=":)";
	// simg[60]="smile1.gif";
	msgstr = replaceAll(msgstr, '_znakk_', '\\');
	msgstr = replaceAll(msgstr, '_znaktzpt_', ';');
	msgstr = replaceAll(msgstr, '_znakplus_', '+');
	msgstr = replaceAll(msgstr, '_znakprocent_', '%');
	msgstr = replaceAll(msgstr, '_znakresh_', '#');
	msgstr = replaceAll(msgstr, '_znakam_', '&amp;');
	msgstr = replaceAll(msgstr, '_tchk_', ';');
	msgstr = replaceAll(msgstr, '_lapka_', '"');
	msgstr = replaceAll(msgstr, '_znakbls_', '&gt;');
	msgstr = replaceAll(msgstr, '_znakmens_', '&lt;');

	var reg_exp = '';
	var sortedIndices = Object.keys(schar).sort(function(a, b) {
		return schar[b].length - schar[a].length;
	});

	var ism = 0;
	while (ism < sortedIndices.length) {
		var index = sortedIndices[ism];
		var findSmile = schar[index] + ' ';
		var reg_exp = new RegExp(findSmile, 'g');

		var smiles = "'" + schar[index] + "'";
		if (msgstr) {
			if (layout_url_all != null) {
				msgstr = msgstr.replace(reg_exp, '<img src="' + layout_url_all
					+ '/smiles/' + simg[index]
					+ '" onclick="parent.fr_send.AddSmilesText(' + smiles
					+ ');">');
			} else {
				msgstr = msgstr.replace(reg_exp,
					'<img src=/img/smiles/' + simg[index] + '">');
			}
		}
		ism++;
	}
	return msgstr;
}
function sok(v) {
	if (blockSend == 0) {
		mstore = Array();
		mstoreC = 0;
	}
}
// ---- Не используется
function P(eM, eCM, eKM) {

}


function PCr(M) {
	// console.log(M);
	if (M == '')
		return '';

	var PM = M.split(";");
     
	var CMDs = '';
	var MSGs1 = '';
	var MSGs2 = '';
	var MSGs3 = '';
	var MSGs4 = '';

	var ref = 0;
    var dfrom='';
	for ( var i = 0; i < PM.length - 1; i++) {
 		
		if (PM[i] != '') {
			
			var PM0 = PM[i].split(">");
			 
            var oldSys=2;
			
            
			// --- Система послала
             dfrom = eval(PM0[5]);
			if ((PM0[1]=='order' || PM0[1]=='chaos'  || PM0[1]=='life' || PM0[1]=='system')  && PM0[5]) {

                  oldSys=2;

				  //PM0[1]='Система';
			}else{
			 

                 //oldSys=1;

			}




            //if (!dfrom[0]['i']){
			//	return ;
			//}
         
            if (PM0[1]=='system' || PM0[1]=='система' || PM0[1]=='Система'  || PM0[1]=='SYSTEM')
            {
               dfrom = eval(PM0[5]);
			   PM0[1]='Система';

            }

			if (dfrom !== undefined  && dfrom!='' && ((dfrom[0]['i'] && dfrom[0]['i'] == 3) || dfrom[0]['n']=='SYSTEM')) {

				ucmd = ' ' + unescape(PM0[8]);
	
				if ((icmd = ucmd.indexOf("/cmd/mail")) >= 0) {

					if (parent.frames['menu']) {
						parent.frames['menu'].showMailImage();
					}
					PM0[8] = 'Вам пришло письмо!';

				}



				if ((icmd = ucmd.indexOf("/cmd/hrB")) >= 0) {
					sBeepM();
					var m2 = parent.main.document.getElementById('FormBattle_');
					if (m2 == null) {
						if (parent.main) {
							if (parent.main.location.href) {
								if (parent.main.location.href
										.indexOf("index.php?") > 0) {
									parent.main.location = parent.main.location.href + '&starts=1';
								} else {
									parent.main.location = "/index.php?file=battle&starts=1";

								}
							}
						}
						ref = 1;
					} else {
						ref = 1;
						continue;
					}
				}

				if ((icmd = ucmd.indexOf("/cmd/logout")) >= 0) {
					parent.main.location = '/index.php?file=logout2&msg=2';
					ref = 1;
				}
				
			 
				 
				if (ref == 0) {
                 
					if (oldSys==1){
                         Ms = m(PM0[2], PM0[3], dfrom[0]['n'], dfrom[0]['i'],dfrom[0]['t'], dfrom[0]['c'], PM0[7], PM0[5],PM0[6], PM0[11], PM0[0]);
                    }
                   if (oldSys==2){
					    
                        Ms = m(PM0[3], PM0[4], dfrom[0]['n'], dfrom[0]['i'],    dfrom[0]['t'], dfrom[0]['c'], PM0[8], PM0[6], PM0[7], PM0[12], PM0[0]);   
                   }
                    
                     
					if (!Ms)
					{
					    continue;
					}
					MSGs1 += Ms;

					if (CommMode == 1) // ????????
					{
						MSGs3 += Ms;

					}

					if (ClanMode == 1) {
						MSGs2 += Ms;

					}
 
					if (AljansMode == 1) {
						MSGs4 += Ms;

					}

				}
				if (Ms) {
					sBeep();
				}
			} else {

//-- detect room
				var   haveRoom=0;
                if (PM0[1]){
                    var room=PM0[1].substr(0,5);
                }
//alert(room);


				if (PM0[1] == 'order'   || PM0[1]=='chaos'  || PM0[1]=='life' ) // Канал 1
				{

					// m(мин,сек,ник,уид,расса,цвет,сообщение,общий лист,приват
					// лист,PM0[10])
                    MSGs1 += m(PM0[3], PM0[4], dfrom[0]['n'], dfrom[0]['i'],    dfrom[0]['t'], dfrom[0]['c'], PM0[8], PM0[6], PM0[7], PM0[12], PM0[0]);
                    haveRoom=1;
                    if (tXFN!=0 && dfrom[0]['i']!=3 && dfrom[0]['i']!=myid){
                        CntMsg_1++;
					}

				}else{

                   // MSGs1 += m(PM0[3], PM0[4], dfrom[0]['n'], dfrom[0]['i'],    dfrom[0]['t'], dfrom[0]['c'], PM0[8], PM0[6], PM0[7], PM0[12], PM0[0]);
				}
				
				if (room == 'guild') // Канал 2 сообщества
				{// alert('Канал 2');
					//MSGs2 += m(PM0[2], PM0[3], dfrom[0]['n'], dfrom[0]['i'],dfrom[0]['t'], dfrom[0]['c'], PM0[7], PM0[5],PM0[6], PM0[11], PM0[0]);
                    MSGs2 += m(PM0[3], PM0[4], dfrom[0]['n'], dfrom[0]['i'],    dfrom[0]['t'], dfrom[0]['c'], PM0[8], PM0[6], PM0[7], PM0[12], PM0[0]);
                    haveRoom=1;
                    if (tXFN!=2 && dfrom[0]['i']!=3 && dfrom[0]['i']!=myid){
                        CntMsg_2++;
                    }

				}
				if (PM0[1] == 3) // Канал 3
				{   //alert('Канал  2');
					MSGs3 += m(PM0[2], PM0[3], dfrom[0]['n'], dfrom[0]['i'],
							dfrom[0]['t'], dfrom[0]['c'], PM0[7], PM0[5],
							PM0[6], PM0[11], PM0[0]);
                    CntMsg_3++;
				}
				if (room == 'aljns' || room =='alj') // Канал 3 Альянс
				{   //alert('Канал 3');
                    MSGs4 += m(PM0[3], PM0[4], dfrom[0]['n'], dfrom[0]['i'],    dfrom[0]['t'], dfrom[0]['c'], PM0[8], PM0[6], PM0[7], PM0[12], PM0[0]);
                    haveRoom=1;
                    if (tXFN!=4 && dfrom[0]['i']!=3 && dfrom[0]['i']!=myid){
                        CntMsg_4++;
                    }

				}
				// console.clear();
				// console.log(room);
				if (room == 'rb_in') // Канал 3 Альянс //COMAND CHAT ЛАБИРИНТ
				{   
                    MSGs3 += m(PM0[3], PM0[4], dfrom[0]['n'], dfrom[0]['i'],    dfrom[0]['t'], dfrom[0]['c'], PM0[8], PM0[6], PM0[7], PM0[12], PM0[0]);
                    haveRoom=1;
                    if (tXFN!=4 && dfrom[0]['i']!=3 && dfrom[0]['i']!=myid){
                        CntMsg_3++;
                    }

				}
			}
			if  (haveRoom==0){ //Not find room
                try {
                    MSGs1 += m(PM0[3], PM0[4], dfrom[0]['n'], dfrom[0]['i'], dfrom[0]['t'], dfrom[0]['c'], PM0[8], PM0[6], PM0[7], PM0[12], PM0[0]);
                }catch (e) {
                    

                }
			}
		}// if
	}

	// Show
    var lenght =0;
	if (MSGs1 != '') {
		writeMsg(MSGs1, 0);
	}
	if (MSGs2 != '') {
		writeMsg(MSGs2, 2);
	}

	if (MSGs3 != '') {
		writeMsg(MSGs3, 1);
	}
	if (MSGs4 != '') {
		writeMsg(MSGs4, 4);
	}

	return '';
}

function ST(MID, PID, CID, KID) {
	// alert("ST="+'cid='+CID+'kid='+KID);
	mid = MID;
	pid = PID;
	cid = CID;
	kid = KID;
}

function GU(id) {
	if (id > 5)
		myid = id;
}
// --- ComXFN
function csXFN(X) {

	switch (X) {
	case "0":
		cXFN(0);
		break;
	case "1":
		cXFN(1);
		break;
	case "2":
		cXFN(2);
		break;
	case "4":
		cXFN(4);
		break;
	default:
		cXFN(X);
	}
}

function cXFN(X) {
	// console.clear();
	// X = 3;
	// console.log(X);
	if (X == 0) {
		tXFN = 0;
		kid = 0;
		cid = 0;

		CntMsg_1=0;
		if (msgdiv == null) {
			msgdiv = parent.fr_main.document.getElementById('msgs');
		}
		if (cmsgdiv == null) {
			cmsgdiv = parent.fr_main.document.getElementById('cmsgs');
		}
		if (kmsgdiv == null){
			kmsgdiv = parent.fr_main.document.getElementById('kmsgs');
		}
		if (amsgsdiv == null) {
			amsgsdiv = parent.fr_main.document.getElementById('amsgs');
		}

		msgdiv.style.display = "block";
		cmsgdiv.style.display = "none";
		kmsgdiv.style.display = "none";
		amsgsdiv.style.display = "none";

		time_click_msgdiv =  new Date().getTime();
		var bar = parent.fr_main.document.querySelector('.simplebar-content-wrapper');
		if (bar != null) {
			bar.scrollTop = bar.scrollHeight;
		}else {
			// statements to handle any unspecified exceptions
            
			parent.fr_main.scroll(0, getHeight(amsgsdiv)- getWindowHeight(parent.fr_main.window) + 20);
		}
			} else if (X == 1) { //COMAND CHAT
			// console.log('work X == 2')
				
        CntMsg_1=0;
		tXFN = 1;
		CommMode = 1;
		if (msgdiv == null)
			msgdiv = parent.fr_main.document.getElementById('msgs');
		if (cmsgdiv == null)
			cmsgdiv = parent.fr_main.document.getElementById('cmsgs');
		if (kmsgdiv == null)
			kmsgdiv = parent.fr_main.document.getElementById('kmsgs');
		if (amsgsdiv == null)
			amsgsdiv = parent.fr_main.document.getElementById('amsgs');
        //
		 time_click_cmsgdiv = new Date().getTime();

		msgdiv.style.display = "none";
		cmsgdiv.style.display = "block";
		kmsgdiv.style.display = "none";
		amsgsdiv.style.display = "none";


		var bar = parent.fr_main.document.querySelector('.simplebar-content-wrapper');
		if (bar != null) {
			bar.scrollTop = bar.scrollHeight;
		}else {
			// statements to handle any unspecified exceptions
            
			parent.fr_main.scroll(0, getHeight(amsgsdiv)- getWindowHeight(parent.fr_main.window) + 20);
		}
		} else if (X == 2) {
		tXFN = 2;
        CntMsg_2=0;
		ClanMode = 1;
		if (msgdiv == null)
			msgdiv = parent.fr_main.document.getElementById('msgs');
		if (cmsgdiv == null)
			cmsgdiv = parent.fr_main.document.getElementById('cmsgs');
		if (kmsgdiv == null)
			kmsgdiv = parent.fr_main.document.getElementById('kmsgs');
		if (amsgsdiv == null)
			amsgsdiv = parent.fr_main.document.getElementById('amsgs');

		 time_click_kmsgdiv = new Date().getTime();

		msgdiv.style.display = "none";
		cmsgdiv.style.display = "none";
		kmsgdiv.style.display = "block";
		amsgsdiv.style.display = "none";

		var bar = parent.fr_main.document.querySelector('.simplebar-content-wrapper');
		if (bar != null) {
			bar.scrollTop = bar.scrollHeight;
		}else {
			// statements to handle any unspecified exceptions
            
			parent.fr_main.scroll(0, getHeight(amsgsdiv)- getWindowHeight(parent.fr_main.window) + 20);
		}

	} else if (X == 4) // Альянс закладка
	{
		tXFN = 4;
        CntMsg_4=0;
		AljansMode = 1;
		if (msgdiv == null)
			msgdiv = parent.fr_main.document.getElementById('msgs');
		if (cmsgdiv == null)
			cmsgdiv = parent.fr_main.document.getElementById('cmsgs');
		if (kmsgdiv == null)
			kmsgdiv = parent.fr_main.document.getElementById('kmsgs');
		if (amsgsdiv == null)
			amsgsdiv = parent.fr_main.document.getElementById('amsgs');

        //
		 time_click_amsgsdiv =new Date().getTime();

		msgdiv.style.display = "none";
		cmsgdiv.style.display = "none";
		kmsgdiv.style.display = "none";
		amsgsdiv.style.display = "block";
		var bar = parent.fr_main.document.querySelector('.simplebar-content-wrapper');
		if (bar != null) {
			bar.scrollTop = bar.scrollHeight;
		}else {
            
			parent.fr_main.scroll(0, getHeight(amsgsdiv)- getWindowHeight(parent.fr_main.window) + 20);
		}

	}
    showCntMsg();
}
function getHeight(o) {
	if (isMSIE || isMozilla || isOpera7)
		return o.offsetHeight
	if (isOpera)
		return this.css.pixelHeight
	if (isNN4)
		return o.document.height
}

function getWindowHeight(w) {
	if (!w)
		w = window
	if (isMSIE)
		return KL_getBody(w).clientHeight
	if (isNN || isOpera)
		return w.innerHeight
}
function KL_getBody(w) {
	if (!w)
		w = window
	if (isStrict) {
		return w.document.documentElement
	} else {
		return w.document.body
	}
}
// ---
function BeepOk(type)
{

    document.getElementById('beepswf2_audio').play();
	//if (megaBeep=='1')
	//{

		//beepmobj=getFlashMovieObject('beepm2');

	//}else
	//     document.getElementById('beepswf_audio').play();
			//beepmobj=getFlashMovieObject('beepm');

	//}
	//if 	(beepmobj)
	//{
		//beepmobj.playSound(type);
	//}
}

function getFlashMovieObject(movieName) {
	if (window.document[movieName]) {
		return window.document[movieName];
	}
	if (navigator.appName.indexOf("Microsoft Internet")==-1) {
		if (document.embeds && document.embeds[movieName]) {
			return document.embeds[movieName];
	    }
	} else // if (navigator.appName.indexOf("Microsoft Internet")!=-1)
	{
		return document.getElementById(movieName);
	}
}
//обработка был ли клик на кнопке общего чата


//---
// ---
// --- The End ---


